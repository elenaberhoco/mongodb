
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5. Les requêtes d’agrégation &#8212; MongoDB : notes de cours</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. Les requêtes de modification" href="06_modif.html" />
    <link rel="prev" title="4. Les index" href="04_index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">MongoDB : notes de cours</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_intro.html">
   MongoDB : Notes de cours
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapitres
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_find.html">
   1. Premières requêtes en MongoDB
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_listes.html">
   2. Attributs de type liste
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_dates.html">
   3. Attributs de type date
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_index.html">
   4. Les index
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   5. Les requêtes d’agrégation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_modif.html">
   6. Les requêtes de modification
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="07_scripts.html">
   7. Effectuer des requêtes depuis des programmes Python ou R
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="07_scripts_py.html">
     7.1. Requêtes depuis Python :
     <code class="docutils literal notranslate">
      <span class="pre">
       pymongo
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="07_scripts_R.html">
     7.2. Requêtes depuis R :
     <code class="docutils literal notranslate">
      <span class="pre">
       mongolite
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/content/05_agreg.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/05_agreg.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rtavenar/mongo_book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rtavenar/mongo_book/issues/new?title=Issue%20on%20page%20%2Fcontent/05_agreg.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rtavenar/mongo_book/main?urlpath=tree/docs/content/05_agreg.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regroupements">
   5.1. Regroupements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateur-de-somme">
     5.1.1. Opérateur de somme
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateur-de-comptage">
     5.1.2. Opérateur de comptage
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateurs-d-extremum">
     5.1.3. Opérateurs d’extremum
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sans-regroupement">
       5.1.3.1. Sans regroupement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#avec-regroupement">
       5.1.3.2. Avec regroupement
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#successions-d-etapes-d-agregation">
   5.2. Successions d’étapes d’agrégation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     5.2.1. Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#project">
     5.2.2. Project
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sort">
     5.2.3. Sort
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limit">
     5.2.4. Limit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#match">
     5.2.5. Match
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unwind">
     5.2.6. Unwind
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#quelques-requetes-pour-tout-comprendre">
     5.2.7. Quelques requêtes pour tout comprendre
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Les requêtes d’agrégation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regroupements">
   5.1. Regroupements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateur-de-somme">
     5.1.1. Opérateur de somme
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateur-de-comptage">
     5.1.2. Opérateur de comptage
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operateurs-d-extremum">
     5.1.3. Opérateurs d’extremum
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sans-regroupement">
       5.1.3.1. Sans regroupement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#avec-regroupement">
       5.1.3.2. Avec regroupement
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#successions-d-etapes-d-agregation">
   5.2. Successions d’étapes d’agrégation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     5.2.1. Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#project">
     5.2.2. Project
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sort">
     5.2.3. Sort
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limit">
     5.2.4. Limit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#match">
     5.2.5. Match
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unwind">
     5.2.6. Unwind
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#quelques-requetes-pour-tout-comprendre">
     5.2.7. Quelques requêtes pour tout comprendre
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="les-requetes-d-agregation">
<h1><span class="section-number">5. </span>Les requêtes d’agrégation<a class="headerlink" href="#les-requetes-d-agregation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="regroupements">
<span id="sec-exec"></span><h2><span class="section-number">5.1. </span>Regroupements<a class="headerlink" href="#regroupements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Auteurs/trices : <strong>CASTRIQUE Jérémy, NOJAC Dimitri, VAVASSEUR Salomé</strong></p></li>
</ul>
<p>Dans cette partie, nous allons étudier <strong>les regroupements dans les requêtes d’aggrégation</strong>. Dans un premier temps, nous étudierons ce qu’est l’étape de regroupement. Ensuite nous regarderons comment effectuer des calculs à l’aide des 4 d’opérateurs qui sont : <code class="docutils literal notranslate"><span class="pre">$sum</span></code>, <code class="docutils literal notranslate"><span class="pre">$max</span></code>, <code class="docutils literal notranslate"><span class="pre">$min</span></code>, <code class="docutils literal notranslate"><span class="pre">$count</span></code> avec ou sans groupe.</p>
<p>Les requêtes de regroupement vont permettre d’effectuer des opérations d’accumulation sur des documents regroupés. Il est l’équivalent de l’opérateur <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> en SQL.</p>
<p><strong>Syntaxe</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
	<span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">expression</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Group By Expression</span>
      		 <span class="o">&lt;</span><span class="nx">field1</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="nx">accumulator1</span><span class="o">&gt;</span> <span class="o">:</span> <span class="o">&lt;</span><span class="nx">expression1</span><span class="o">&gt;</span> <span class="p">},</span>
      		<span class="p">...}</span>
	<span class="p">}</span>
<span class="p">])</span>
</pre></div>
</div>
<p>Pour tous les opérateurs que nous allons étudier dans cette partie du cours, la syntaxe sera identique à celle-ci.</p>
<div class="section" id="operateur-de-somme">
<h3><span class="section-number">5.1.1. </span>Opérateur de somme<a class="headerlink" href="#operateur-de-somme" title="Permalink to this headline">¶</a></h3>
<p>L’équivalent en SQL de l’opérateur <code class="docutils literal notranslate"><span class="pre">$sum</span></code> est <code class="docutils literal notranslate"><span class="pre">SUM</span></code> qui permet de sommer les valeurs prises pour un attribut.</p>
<p><strong>Exemple de requête sans regroupement</strong></p>
<div class="tabbed-set docutils">
<input checked="checked" id="37a166bf-18c5-4d00-9c07-acb99ba7f3b6" name="3f39d671-345a-4ceb-bdfd-b26870697acb" type="radio">
</input><label class="tabbed-label" for="37a166bf-18c5-4d00-9c07-acb99ba7f3b6">
MongoDB</label><div class="tabbed-content docutils">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
  <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> 
    	   <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="s2">&quot;$att&quot;</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<input id="fbb2cb23-da93-40b9-b805-d3acc047dfa8" name="3f39d671-345a-4ceb-bdfd-b26870697acb" type="radio">
</input><label class="tabbed-label" for="fbb2cb23-da93-40b9-b805-d3acc047dfa8">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">att</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nb</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>Vous remarquez qu’ici l’expression qui guide le regroupement est <code class="docutils literal notranslate"><span class="pre">null</span></code>, soit une constante.
Cela signifie que tous les documents de la base seront regroupés ensemble et qu’un seul calcul sera fait pour ce groupe.</p>
<p><strong>Exemple de requête avec regroupement</strong></p>
<p>Pour créer des groupes d’individus, il faut indiquer comment former ces groupes dans l’identifiant.</p>
<p>Sur la base de <code class="docutils literal notranslate"><span class="pre">food</span></code>, on peut par exemple filtrer par quartier.</p>
<p>Voici un exemple de requête :</p>
<p><em>En mongoDB :</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">use</span> <span class="nx">food</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>switched to db food
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
  <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$borough&quot;</span><span class="p">,</span>
    	   <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="p">{</span><span class="nx">$size</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">}}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;Bronx&quot;, &quot;nb&quot; : 8706 }
{ &quot;_id&quot; : &quot;Staten Island&quot;, &quot;nb&quot; : 3216 }
{ &quot;_id&quot; : &quot;Queens&quot;, &quot;nb&quot; : 20877 }
{ &quot;_id&quot; : &quot;Brooklyn&quot;, &quot;nb&quot; : 21962 }
{ &quot;_id&quot; : &quot;Missing&quot;, &quot;nb&quot; : 79 }
{ &quot;_id&quot; : &quot;Manhattan&quot;, &quot;nb&quot; : 38617 }
</pre></div>
</div>
</div>
</div>
<p><em>En SQL :</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">n_grades</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nb</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
</pre></div>
</div>
<p>Dans cette requête, MongoDB va regrouper les individus ayant la même valweur pour l’attribut spécifié comme <code class="docutils literal notranslate"><span class="pre">_id</span></code> et donc considérer les restaurants d’un même quartier ensemble.</p>
<p>L’opérateur <code class="docutils literal notranslate"><span class="pre">$sum</span></code> permet de calculer et de retourner les sommes de variables numériques (ici les sommes des nombres de notes).</p>
<div class="tip admonition">
<p class="admonition-title">Attention</p>
<p>Il ne prend pas en compte les variables non numériques.</p>
</div>
<p><strong>Syntaxe</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="kd">var</span><span class="o">&gt;</span><span class="p">,</span>
	      <span class="nx">somme</span> <span class="o">:</span><span class="p">{</span> <span class="nx">$sum</span><span class="o">:</span> <span class="p">[</span> <span class="o">&lt;</span><span class="nx">expression1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">expression2</span><span class="o">&gt;</span> <span class="p">...</span> <span class="p">]}}}</span>
     <span class="p">}</span>
<span class="p">])</span>
</pre></div>
</div>
<p><strong>Autre exemple</strong></p>
<p>Pour cette partie, nous allons nous placer dans cette base que nous avons créée.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">1</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">2</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">2</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">20</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">1</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">3</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">4</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">}</span>
</pre></div>
</div>
<p><em><strong>Sans regroupement</strong></em>
Jusqu’ici, nous avons compté le nombre d’individus grâce à l’attribu <code class="docutils literal notranslate"><span class="pre">$sum</span></code>, mais celui ci permet aussi <code class="docutils literal notranslate"><span class="pre">d'additionner</span> <span class="pre">des</span> <span class="pre">variables</span></code>.</p>
<p>On se place maintenant dans la collection précédente.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="e9267de1-7533-4ecf-a1b9-7249ddbf8431" name="4df0a48b-7240-4dc3-bf7b-32d383557a91" type="radio">
</input><label class="tabbed-label" for="e9267de1-7533-4ecf-a1b9-7249ddbf8431">
MongoDB</label><div class="tabbed-content docutils">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
	<span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
		 <span class="nx">qtt_tot</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="s2">&quot;$quantité&quot;</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<input id="edd64f92-efdd-4343-9eed-402ed2b7f9f4" name="4df0a48b-7240-4dc3-bf7b-32d383557a91" type="radio">
</input><label class="tabbed-label" for="edd64f92-efdd-4343-9eed-402ed2b7f9f4">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantité</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtt_tot</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">coll</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Résultat obtenu :</strong></em></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* 1 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="s2">&quot;qtt_tot&quot;</span> <span class="o">:</span> <span class="mf">28.0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ici, on calcule la somme des quantités vendues.</p>
<p><em><strong>Avec regroupement</strong></em>
Si on veut sélectionner les sommes des durées de films par genre, il suffit de rajouter un regroupement comme le suivant :</p>
<div class="tabbed-set docutils">
<input checked="checked" id="131c9afe-3bfd-40cf-a4a3-fe421fdaed51" name="7a537707-8b5e-412c-9a41-a8428c2c2c08" type="radio">
</input><label class="tabbed-label" for="131c9afe-3bfd-40cf-a4a3-fe421fdaed51">
MongoDB</label><div class="tabbed-content docutils">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
	<span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$prix&quot;</span><span class="p">,</span>
		 <span class="nx">qtt_tot</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="s2">&quot;$quantité&quot;</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<input id="df015443-51c5-4141-b73f-665beb868395" name="7a537707-8b5e-412c-9a41-a8428c2c2c08" type="radio">
</input><label class="tabbed-label" for="df015443-51c5-4141-b73f-665beb868395">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantité</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">qtt_tot</span><span class="w"> </span>
<span class="k">FROM</span><span class="w"> </span><span class="n">coll</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">prix</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Résultat obtenu :</strong></em></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* 1 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="s2">&quot;qtt_tot&quot;</span> <span class="o">:</span> <span class="mf">1.0</span>
<span class="p">}</span>
 
<span class="cm">/* 2 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;qtt_tot&quot;</span> <span class="o">:</span> <span class="mf">12.0</span>
<span class="p">}</span>
 
<span class="cm">/* 3 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="s2">&quot;qtt_tot&quot;</span> <span class="o">:</span> <span class="mf">15.0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="operateur-de-comptage">
<h3><span class="section-number">5.1.2. </span>Opérateur de comptage<a class="headerlink" href="#operateur-de-comptage" title="Permalink to this headline">¶</a></h3>
<p>L’opérateur <code class="docutils literal notranslate"><span class="pre">$count</span></code> renvoie le nombre de documents présents dans l’aggrégation.</p>
<p>Dans cet exemple, on assigne à la valeur NB_+24 le nombre de documents ayant un individu avec un âge supérieur à 24 :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">use</span> <span class="nx">large_db</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>switched to db large_db
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gt</span><span class="o">:</span> <span class="mf">24</span><span class="p">}}},</span>
    <span class="p">{</span><span class="nx">$count</span><span class="o">:</span> <span class="s2">&quot;NB_+24&quot;</span><span class="p">}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>L’opérateur <code class="docutils literal notranslate"><span class="pre">$match</span></code> exclu les documents qui possèdent un individu avec un âge &lt;24.
L’opérateur <code class="docutils literal notranslate"><span class="pre">$count</span></code> va donc agir sur les documents ayant un individu avec un âge supérieur à 24 à l’opérateur <code class="docutils literal notranslate"><span class="pre">$gt</span></code> (plus grand que) et va assigner
à la valeur NB_+24 le nombre de documents répondant au critère.</p>
<p>Une autre façon (moins directe) d’effectuer des opérations de comptage est d’utiliser l’opérateur <code class="docutils literal notranslate"><span class="pre">$sum</span></code>.</p>
<p><em><strong>Sans regroupement</strong></em>
Regardons une requête simple :</p>
<p><em>En mongoDB :</em></p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
      <span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="mf">1</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><em>En SQL :</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nb</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"></span>
</pre></div>
</div>
<p>On utilise la fonction aggregate.
Lorsqu’on utilise aggregate, il faut donner les individus sur lesquels on veut faire la requête.
Dans notre cas, on choisit tout les individus. On le note <code class="docutils literal notranslate"><span class="pre">id:</span> <span class="pre">null</span></code>.
On créé notre variable qu’on appelle nb qui va faire la somme de tout les individus.</p>
<p>Dans cet exemple, nous avons compté le nombre d’individus sans sélection.</p>
<p>En pratique, cela n’a pas forcément beaucoup d’intérêt.
Il s’avère plus utile de pouvoir sélectionner le nombre de variables répondant à un critère. Pour cela, nous allons regarder avec une requête de regroupement.</p>
<p><em><strong>Avec regroupement</strong></em>
Toujours dans la collection NYfood de la base food, on cherche à connaitre le nombre de restaurants par type de cuisine. Pour cela, on va effectuer un regroupement sur l’attribut “cuisine”.</p>
<p><em>En mongoDB :</em></p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
      <span class="p">{</span><span class="nx">$group</span><span class="o">:</span><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$cuisine&quot;</span><span class="p">,</span>
              <span class="nx">nb_par_cuis</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="mf">1</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><em>En SQL :</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nb_par_cuisine</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">cuisine</span><span class="w"></span>
</pre></div>
</div>
<p>On obtient donc plusieurs listes différentes contenant pour chacune le nombre de restaurants dans chaque liste nommée par le type de cuisine.</p>
<p>Il y a donc eu un comptage du nombre de restaurants en fonction de la variable cuisine.</p>
</div>
<div class="section" id="operateurs-d-extremum">
<h3><span class="section-number">5.1.3. </span>Opérateurs d’extremum<a class="headerlink" href="#operateurs-d-extremum" title="Permalink to this headline">¶</a></h3>
<p><strong>Syntaxe</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">coll</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span>
         <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="kd">var</span><span class="o">&gt;</span><span class="p">,</span>
	   <span class="nx">max</span><span class="o">:</span> <span class="p">{</span><span class="nx">$max</span><span class="o">:</span> <span class="p">[</span> <span class="o">&lt;</span><span class="nx">expression1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">expression2</span><span class="o">&gt;</span> <span class="p">...</span> <span class="p">]}}}</span>
     <span class="p">}</span>
   <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Pour cette partie on se basera sur cette collection pour les exemples :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">1</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">2</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">2</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">20</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">1</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">3</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">4</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">},</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;objet&quot;</span> <span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;prix&quot;</span> <span class="o">:</span> <span class="mf">5</span><span class="p">,</span> <span class="s2">&quot;quantité&quot;</span> <span class="o">:</span> <span class="mf">10</span><span class="p">}</span>
</pre></div>
</div>
<p>Nous allons nous intéresser aux opérateurs <code class="docutils literal notranslate"><span class="pre">$min</span></code> et <code class="docutils literal notranslate"><span class="pre">$max</span></code> au sein de l’opéarteur <code class="docutils literal notranslate"><span class="pre">$group</span></code>,
ils peuvent aussi être utilisés dans l’opérateur <code class="docutils literal notranslate"><span class="pre">$project</span></code> que nous verrons en deuxième partie de chapitre.
En SQL, les équivalents sont les opérateurs <code class="docutils literal notranslate"><span class="pre">MIN</span></code>et `MAX.</p>
<div class="section" id="sans-regroupement">
<h4><span class="section-number">5.1.3.1. </span>Sans regroupement<a class="headerlink" href="#sans-regroupement" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">$min</span></code> et <code class="docutils literal notranslate"><span class="pre">$max</span></code> s’ils sont utilisés sans regroupement retournent respectivement la valeur minimale et la valeur maximale
de l’attribut sur lequel ils sont appliqués et ceci sur tous les documents.</p>
<p><em>Exemple :</em></p>
<div class="tabbed-set docutils">
<input checked="checked" id="91e9fee1-d349-4b21-965f-393c89fc1c8e" name="eaa0caa2-b9a9-4632-9d9b-d45a6d615cda" type="radio">
</input><label class="tabbed-label" for="91e9fee1-d349-4b21-965f-393c89fc1c8e">
MongoDB</label><div class="tabbed-content docutils">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">ventes</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
	<span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nx">prix_max</span><span class="o">:</span> <span class="p">{</span><span class="nx">$max</span><span class="o">:</span> <span class="s2">&quot;$prix&quot;</span><span class="p">},</span>
                  <span class="nx">prix_min</span><span class="o">:</span> <span class="p">{</span><span class="nx">$min</span><span class="o">:</span> <span class="s2">&quot;$prix&quot;</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<input id="1330311b-997a-4ddf-8840-3ebae93b50e0" name="eaa0caa2-b9a9-4632-9d9b-d45a6d615cda" type="radio">
</input><label class="tabbed-label" for="1330311b-997a-4ddf-8840-3ebae93b50e0">
Équivalent SQL</label><div class="tabbed-content docutils">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">prix</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;prix max&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">prix</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;prix min&quot;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">ventes</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Attention</p>
<p>Ne pas oublier le “$” dans les attributs entre guillemets à droite des deux points pour bien faire référence à l’attribut
et non à une chaîne de caractères.</p>
</div>
<p>Cette requête renvoie la valeur maximale puis minimale que prend la variable <code class="docutils literal notranslate"><span class="pre">$prix</span></code> sur tous les documents :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="s2">&quot;prix_max&quot;</span> <span class="o">:</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="s2">&quot;prix_min&quot;</span> <span class="o">:</span> <span class="mf">5.0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="avec-regroupement">
<h4><span class="section-number">5.1.3.2. </span>Avec regroupement<a class="headerlink" href="#avec-regroupement" title="Permalink to this headline">¶</a></h4>
<p>On peut aussi réaliser un regroupement et ainsi <code class="docutils literal notranslate"><span class="pre">$min</span></code> et <code class="docutils literal notranslate"><span class="pre">$max</span></code> renvoient toujours la valeur minimale et la valeur maximale
de l’attribut sur lequel ils sont appliqués, mais cette fois-ci en étant appliqués sur les documents de l’ensemble de documents qui partagent la même clé de regroupement.</p>
<p><em>Exemple :</em></p>
<div class="tabbed-set docutils">
<input checked="checked" id="1745d867-59a2-4956-8fed-42328943bffa" name="407c8ec4-410d-4a2e-a619-790f12a9b6ef" type="radio">
</input><label class="tabbed-label" for="1745d867-59a2-4956-8fed-42328943bffa">
MongoDB</label><div class="tabbed-content docutils">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">ventes</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
	<span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span><span class="s2">&quot;$objet&quot;</span><span class="p">,</span>
                  <span class="nx">quantité_max</span><span class="o">:</span> <span class="p">{</span><span class="nx">$max</span><span class="o">:</span> <span class="s2">&quot;$quantité&quot;</span><span class="p">},</span>
                  <span class="nx">quantité_min</span><span class="o">:</span> <span class="p">{</span><span class="nx">$min</span><span class="o">:</span> <span class="s2">&quot;$quantité&quot;</span><span class="p">}}}</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<input id="9efb3774-51a7-441e-9df3-522015b7547e" name="407c8ec4-410d-4a2e-a619-790f12a9b6ef" type="radio">
</input><label class="tabbed-label" for="9efb3774-51a7-441e-9df3-522015b7547e">
Équivalent SQL</label><div class="tabbed-content docutils">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">prix</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;prix max&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">prix</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;prix min&quot;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">ventes</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">quantité</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>On groupe à l’aide de la clé <code class="docutils literal notranslate"><span class="pre">objet</span></code>,
on renvoie donc la valeur maximale puis minimale que prend la variable <code class="docutils literal notranslate"><span class="pre">quantité</span></code> pour chaque <code class="docutils literal notranslate"><span class="pre">objet</span></code> différent :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantité_max&quot;</span> <span class="o">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;quantité_min&quot;</span> <span class="o">:</span> <span class="mf">2.0</span>
<span class="p">}</span>

<span class="cm">/* 2 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantité_max&quot;</span> <span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;quantité_min&quot;</span> <span class="o">:</span> <span class="mf">1.0</span>
<span class="p">}</span>

<span class="cm">/* 3 */</span>
<span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantité_max&quot;</span> <span class="o">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;quantité_min&quot;</span> <span class="o">:</span> <span class="mf">5.0</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition-null-ou-inexistant admonition">
<p class="admonition-title">Null ou inexistant</p>
<p>Si certains documents ont une valeur de type null ou qui n’existe pas pour l’attribut sur lequel on applique <code class="docutils literal notranslate"><span class="pre">$min</span></code> ou <code class="docutils literal notranslate"><span class="pre">$max</span></code>,
les opérateurs ne prennent pas en compte les valeurs de type null ou manquantes pour le calcul.
Si tous les documents ont une valeur de type null ou qui n’existe pas, les opérateurs renvoient null pour la valeur minimale
ou la valeur maximale.</p>
</div>
</div>
</div>
</div>
<div class="section" id="successions-d-etapes-d-agregation">
<h2><span class="section-number">5.2. </span>Successions d’étapes d’agrégation<a class="headerlink" href="#successions-d-etapes-d-agregation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Auteurs/trices : <strong>Marine BINARD, Yann CAUSEUR, Arthur CONAS</strong></p></li>
</ul>
<div class="section" id="introduction">
<h3><span class="section-number">5.2.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>Les successions d’étapes d’agrégation vont permettre d’obtenir des requêtes proches de ce qu’on peut trouver en SQL.
Contrairement à SQL où l’ordre est pré-défini (<code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">FROM</span> <span class="pre">WHERE</span> <span class="pre">ORDER</span> <span class="pre">BY</span></code>), ici ce n’est pas le cas. Il n’empêche que <strong>l’ordre dans lequel on place
nos étapes est crucial.</strong></p>
<p>Nos étapes peuvent toutes être effectuées une à une et indépendamment. En fait, à l’intérieur de notre <code class="docutils literal notranslate"><span class="pre">db.coll.aggregate([])</span></code>, il y aura notre liste d’étapes,
contenues dans des crochets et séparées par des virgules, qui s’effectueront sur les données que <strong>l’étape d’avant aura rendue.</strong></p>
<p>Il peut donc être intéressant d’éxécuter le code étape par étape pour savoir sur quelles données on travaille à un moment donné.</p>
<p>Dans la suite, nous présentons de nouvelles étapes d’agrégation.</p>
</div>
<div class="section" id="project">
<h3><span class="section-number">5.2.2. </span>Project<a class="headerlink" href="#project" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Pourquoi l’utiliser ?</strong></em><br />
Il peut arriver lors d’une requête d’agrégation de vouloir créer de nouvelles variables par exemple, pour des calculs. La commande <code class="docutils literal notranslate"><span class="pre">$project</span></code> permet donc de créer de nouvelles variables. Néanmoins, il faut faire attention,
lorsque l’on crée une nouvelle variable dans une requête d’agrégation.
Tous les attributs déjà existants pour les documents d’une collection ne sont plus mémorisés. Donc, si on veut créer une nouvelle variable, tout en gardant celles déjà existantes, il faut le mentionner dans le <code class="docutils literal notranslate"><span class="pre">$project</span></code>.</p>
<p><em><strong>Comment ça fonctionne ?</strong></em></p>
<p><strong>Syntaxe</strong> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>db.coll.aggregate( 
  [
    {$project : {&lt;nom_nouv_att1&gt; : &lt;val_att1&gt;, &lt;nom_nouv_att2&gt; : &lt;val_att2&gt;, ... }}
  ]
)
</pre></div>
</div>
<p>Le fait de vouloir garder un attribut déjà existant fonctionne de la même façon que la création, il faut donc renommer la variable existante.</p>
<p><em><strong>Exemple :</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">use</span> <span class="nx">food</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>switched to db food
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> 
  <span class="p">[</span>
    <span class="p">{</span><span class="nx">$project</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;n_notes&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="nx">$size</span> <span class="o">:</span> <span class="s1">&#39;$grades&#39;</span><span class="p">}}}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c681&quot;), &quot;n_notes&quot; : 5 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c683&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c684&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c686&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c687&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;n_notes&quot; : 6 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c689&quot;), &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68a&quot;), &quot;n_notes&quot; : 3 }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p>Sur l’exemple ci-dessus, on vient créer une variable n_notes qui prend pour valeur la taille de la liste <code class="docutils literal notranslate"><span class="pre">grades</span></code>
(qui contient les différentes notes attribuées aux restaurants).
On cherche donc, ici, à compter le nombre de notes attribué à chaque restaurant.
Mais tous les autres attributs du restaurant sont effacés. Par la suite,
on ne pourra donc retrouver que le nombre de notes attribué et non le quartier
ou le type de restaurant.
Si on veut afficher le quartier en question, on doit le préciser tel que :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> 
  <span class="p">[</span>
    <span class="p">{</span><span class="nx">$project</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;n_notes&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="nx">$size</span> <span class="o">:</span> <span class="s1">&#39;$grades&#39;</span><span class="p">},</span> <span class="nx">quartier</span> <span class="o">:</span><span class="s1">&#39;$borough&#39;</span><span class="p">}}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c681&quot;), &quot;n_notes&quot; : 5, &quot;quartier&quot; : &quot;Bronx&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Brooklyn&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c683&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Manhattan&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c684&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Queens&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Brooklyn&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c686&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Queens&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c687&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Staten Island&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;n_notes&quot; : 6, &quot;quartier&quot; : &quot;Brooklyn&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c689&quot;), &quot;n_notes&quot; : 4, &quot;quartier&quot; : &quot;Brooklyn&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68a&quot;), &quot;n_notes&quot; : 3, &quot;quartier&quot; : &quot;Bronx&quot; }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p>Avec cette requête, on peut voir le quartier du restaurant. Par ailleurs, la variable <code class="docutils literal notranslate"><span class="pre">borough</span></code>
a été renommée <code class="docutils literal notranslate"><span class="pre">quartier</span></code>. On peut également conserver cette
variable sans la renommer avec cette syntaxe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> 
  <span class="p">[</span>
    <span class="p">{</span><span class="nx">$project</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;n_notes&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="nx">$size</span> <span class="o">:</span> <span class="s1">&#39;$grades&#39;</span><span class="p">},</span> <span class="nx">borough</span> <span class="o">:</span> <span class="mf">1</span><span class="p">}}</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c681&quot;), &quot;borough&quot; : &quot;Bronx&quot;, &quot;n_notes&quot; : 5 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c683&quot;), &quot;borough&quot; : &quot;Manhattan&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c684&quot;), &quot;borough&quot; : &quot;Queens&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c686&quot;), &quot;borough&quot; : &quot;Queens&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c687&quot;), &quot;borough&quot; : &quot;Staten Island&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;n_notes&quot; : 6 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c689&quot;), &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;n_notes&quot; : 4 }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68a&quot;), &quot;borough&quot; : &quot;Bronx&quot;, &quot;n_notes&quot; : 3 }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p><em><strong>Traduction SQL :</strong></em></p>
<p>L’équivalent en SQL de la commande <code class="docutils literal notranslate"><span class="pre">$project</span></code> est l’étape <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> et <code class="docutils literal notranslate"><span class="pre">AS</span></code> qui
permettent de créer de nouvelles variables. Par contre, en SQL,
l’étape <code class="docutils literal notranslate"><span class="pre">AS</span></code> est facultative, la nouvelle variable prendra
comme nom la formule du calcul. En MongoDB, elle est obligatoire !
Si on ne précise pas le nom de la nouvelle variable, cela affichera
une erreur. Pour la traduction SQL de l’exemple précédent, il convient de faire attention.
Pour rappel, les listes n’existent pas en SQL ! D’où la nécessité
dans certains moments de faire des calculs verticaux, ce qui n’est pas nécéssaire.
Dans notre cas, en SQL l’attribut <code class="docutils literal notranslate"><span class="pre">grades</span></code> serait une table à part entière (avec toutes les notes <code class="docutils literal notranslate"><span class="pre">grade</span></code>, une clé étrangère faisant référence au restaurant)
Il faudrait donc faire une jointure sur celle-ci puis grouper par restaurant (en imaginant qu’il existe un ID pour chaque restaurant)
L’exemple serait donc:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"> </span><span class="k">NATURAL</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">grades</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">restoID</span><span class="w"></span>
<span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;n_notes&quot;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="sort">
<h3><span class="section-number">5.2.3. </span>Sort<a class="headerlink" href="#sort" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Pourquoi l’utiliser ?</strong></em></p>
<p>Comme dans la plus part des langages de bases de données, MongoDB ne stocke pas les documents dans une collection dans un ordre
en particulier. C’est pourquoi l’étape <code class="docutils literal notranslate"><span class="pre">sort</span></code> (tri en français) va permettre
de trier l’ensemble de tous les documents d’entrée afin de les renvoyer dans
l’ordre choisi par l’utilisateur. Nous pouvons les trier dans l’ordre croissant,
décroissant, chronologique ou bien alphabétique selon le type du champ
souhaitant être trié.
Il est possible de trier sur plusieurs champs à la fois, mais dans ce cas l’ordre de tri est évalué de gauche à droite.
Le <code class="docutils literal notranslate"><span class="pre">$sort</span></code> est finalement l’équivalent du <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> en SQL.</p>
<p><em><strong>Comment ça fonctionne ?</strong></em></p>
<p><strong>Syntaxe</strong> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>db.coll.aggregate(
	[
	 {$sort: {&lt;champ1&gt;: &lt;sort order&gt;, &lt;champ2&gt;: &lt;sort order&gt; ...}}
	]
)
</pre></div>
</div>
<p>Le <code class="docutils literal notranslate"><span class="pre">&lt;sort</span> <span class="pre">order&gt;</span></code> peut prendre la valeur : 1 (croissant), -1 (décroissant) ou encore <code class="docutils literal notranslate"><span class="pre">{$meta:</span> <span class="pre">&quot;textScore&quot;}</span></code>(il s’agit d’un tri de métadonnées textScore calculées dans l’ordre décroissant).</p>
<p><em><strong>Exemples :</strong></em></p>
<p>Attention à bien prendre en compte le fait que lors du
tri sur un champ contenant des valeurs en double (ou non unique),
les documents contenant ces valeurs peuvent être renvoyés dans
n’importe quel ordre.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
   <span class="p">[</span>
	 <span class="p">{</span><span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span><span class="nx">borough</span> <span class="o">:</span> <span class="mf">1</span><span class="p">}}</span>
   <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c681&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1007&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.856077, 40.848447 ] }, &quot;street&quot; : &quot;Morris Park Ave&quot;, &quot;zipcode&quot; : &quot;10462&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Bakery&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-03-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 }, { &quot;date&quot; : ISODate(&quot;2013-09-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 6 }, { &quot;date&quot; : ISODate(&quot;2013-01-24T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-11-23T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2011-03-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 14 } ], &quot;name&quot; : &quot;Morris Park Bake Shop&quot;, &quot;restaurant_id&quot; : &quot;30075445&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68a&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2300&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8786113, 40.8502883 ] }, &quot;street&quot; : &quot;Southern Boulevard&quot;, &quot;zipcode&quot; : &quot;10460&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-05-28T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2013-06-19T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 4 }, { &quot;date&quot; : ISODate(&quot;2012-06-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 3 } ], &quot;name&quot; : &quot;Wild Asia&quot;, &quot;restaurant_id&quot; : &quot;40357217&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6a0&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1006&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.84856870000002, 40.8903781 ] }, &quot;street&quot; : &quot;East 233 Street&quot;, &quot;zipcode&quot; : &quot;10466&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Ice Cream, Gelato, Yogurt, Ices&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-04-24T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-09-05T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-02-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-07-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2011-07-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 } ], &quot;name&quot; : &quot;Carvel Ice Cream&quot;, &quot;restaurant_id&quot; : &quot;40363093&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6a4&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1236&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8893654, 40.81376179999999 ] }, &quot;street&quot; : &quot;238 Spofford Ave&quot;, &quot;zipcode&quot; : &quot;10474&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Chinese&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2013-12-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, { &quot;date&quot; : ISODate(&quot;2013-01-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-06-12T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 15 } ], &quot;name&quot; : &quot;Happy Garden&quot;, &quot;restaurant_id&quot; : &quot;40363289&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6b5&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;277&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8941893, 40.8634684 ] }, &quot;street&quot; : &quot;East Kingsbridge Road&quot;, &quot;zipcode&quot; : &quot;10458&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Chinese&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-03-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-09-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-03-19T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-08-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2011-08-17T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 } ], &quot;name&quot; : &quot;Happy Garden&quot;, &quot;restaurant_id&quot; : &quot;40364296&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6be&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;658&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.81363999999999, 40.82941100000001 ] }, &quot;street&quot; : &quot;Clarence Ave&quot;, &quot;zipcode&quot; : &quot;10465&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-06-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2012-07-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 } ], &quot;name&quot; : &quot;Manhem Club&quot;, &quot;restaurant_id&quot; : &quot;40364363&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6d7&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2222&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.84971759999999, 40.8304811 ] }, &quot;street&quot; : &quot;Haviland Avenue&quot;, &quot;zipcode&quot; : &quot;10462&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-12-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, { &quot;date&quot; : ISODate(&quot;2014-05-01T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 17 }, { &quot;date&quot; : ISODate(&quot;2013-03-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2012-09-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-02-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 19 } ], &quot;name&quot; : &quot;The New Starling Athletic Club Of The Bronx&quot;, &quot;restaurant_id&quot; : &quot;40364956&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6f8&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;72&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.92506, 40.8275556 ] }, &quot;street&quot; : &quot;East  161 Street&quot;, &quot;zipcode&quot; : &quot;10451&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-04-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2013-11-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 4 }, { &quot;date&quot; : ISODate(&quot;2013-07-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-12-31T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 15 }, { &quot;date&quot; : ISODate(&quot;2012-05-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-01-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-08-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;C&quot;, &quot;score&quot; : 37 } ], &quot;name&quot; : &quot;Yankee Tavern&quot;, &quot;restaurant_id&quot; : &quot;40365499&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c700&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;331&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.87786539999999, 40.8724377 ] }, &quot;street&quot; : &quot;East  204 Street&quot;, &quot;zipcode&quot; : &quot;10467&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Irish&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-08-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2014-03-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 23 }, { &quot;date&quot; : ISODate(&quot;2013-09-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-12-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 27 }, { &quot;date&quot; : ISODate(&quot;2011-10-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 } ], &quot;name&quot; : &quot;Mcdwyers Pub&quot;, &quot;restaurant_id&quot; : &quot;40365893&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c71a&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;5820&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9002615, 40.885186 ] }, &quot;street&quot; : &quot;Broadway&quot;, &quot;zipcode&quot; : &quot;10463&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-02-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2013-10-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 19 }, { &quot;date&quot; : ISODate(&quot;2013-05-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-11-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 18 }, { &quot;date&quot; : ISODate(&quot;2011-10-17T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-06-22T00:00:00Z&quot;), &quot;grade&quot; : &quot;C&quot;, &quot;score&quot; : 35 } ], &quot;name&quot; : &quot;The Punch Bowl&quot;, &quot;restaurant_id&quot; : &quot;40366497&quot; }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p><em><strong>Traduction SQL :</strong></em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"> </span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
</pre></div>
</div>
<p>En effet, dans l’exemple ci-dessus, le champ quartier n’est
pas un champ avec des valeurs uniques. Si un ordre de tri
cohérent est souhaité, il est important d’au moins inclure
un champ dans votre tri qui contient des valeurs uniques.
Généralement, le moyen le plus simple de garantir cela consiste
à inclure le champ _id dans la requête de tri.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
   <span class="p">[</span>
     <span class="p">{</span><span class="nx">$sort</span> <span class="o">:</span> <span class="p">{</span><span class="nx">borough</span> <span class="o">:</span> <span class="mf">1</span><span class="p">,</span> <span class="nx">_id</span> <span class="o">:</span> <span class="mf">1</span><span class="p">}}</span>
   <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c681&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1007&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.856077, 40.848447 ] }, &quot;street&quot; : &quot;Morris Park Ave&quot;, &quot;zipcode&quot; : &quot;10462&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Bakery&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-03-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 }, { &quot;date&quot; : ISODate(&quot;2013-09-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 6 }, { &quot;date&quot; : ISODate(&quot;2013-01-24T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-11-23T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2011-03-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 14 } ], &quot;name&quot; : &quot;Morris Park Bake Shop&quot;, &quot;restaurant_id&quot; : &quot;30075445&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68a&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2300&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8786113, 40.8502883 ] }, &quot;street&quot; : &quot;Southern Boulevard&quot;, &quot;zipcode&quot; : &quot;10460&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-05-28T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2013-06-19T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 4 }, { &quot;date&quot; : ISODate(&quot;2012-06-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 3 } ], &quot;name&quot; : &quot;Wild Asia&quot;, &quot;restaurant_id&quot; : &quot;40357217&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6a0&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1006&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.84856870000002, 40.8903781 ] }, &quot;street&quot; : &quot;East 233 Street&quot;, &quot;zipcode&quot; : &quot;10466&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Ice Cream, Gelato, Yogurt, Ices&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-04-24T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-09-05T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-02-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-07-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2011-07-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 } ], &quot;name&quot; : &quot;Carvel Ice Cream&quot;, &quot;restaurant_id&quot; : &quot;40363093&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6a4&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1236&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8893654, 40.81376179999999 ] }, &quot;street&quot; : &quot;238 Spofford Ave&quot;, &quot;zipcode&quot; : &quot;10474&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Chinese&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2013-12-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, { &quot;date&quot; : ISODate(&quot;2013-01-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-06-12T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 15 } ], &quot;name&quot; : &quot;Happy Garden&quot;, &quot;restaurant_id&quot; : &quot;40363289&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6b5&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;277&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.8941893, 40.8634684 ] }, &quot;street&quot; : &quot;East Kingsbridge Road&quot;, &quot;zipcode&quot; : &quot;10458&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Chinese&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-03-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-09-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-03-19T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-08-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2011-08-17T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 } ], &quot;name&quot; : &quot;Happy Garden&quot;, &quot;restaurant_id&quot; : &quot;40364296&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6be&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;658&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.81363999999999, 40.82941100000001 ] }, &quot;street&quot; : &quot;Clarence Ave&quot;, &quot;zipcode&quot; : &quot;10465&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-06-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2012-07-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 } ], &quot;name&quot; : &quot;Manhem Club&quot;, &quot;restaurant_id&quot; : &quot;40364363&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6d7&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2222&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.84971759999999, 40.8304811 ] }, &quot;street&quot; : &quot;Haviland Avenue&quot;, &quot;zipcode&quot; : &quot;10462&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-12-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, { &quot;date&quot; : ISODate(&quot;2014-05-01T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 17 }, { &quot;date&quot; : ISODate(&quot;2013-03-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2012-09-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-02-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 19 } ], &quot;name&quot; : &quot;The New Starling Athletic Club Of The Bronx&quot;, &quot;restaurant_id&quot; : &quot;40364956&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c6f8&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;72&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.92506, 40.8275556 ] }, &quot;street&quot; : &quot;East  161 Street&quot;, &quot;zipcode&quot; : &quot;10451&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-04-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2013-11-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 4 }, { &quot;date&quot; : ISODate(&quot;2013-07-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-12-31T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 15 }, { &quot;date&quot; : ISODate(&quot;2012-05-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-01-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-08-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;C&quot;, &quot;score&quot; : 37 } ], &quot;name&quot; : &quot;Yankee Tavern&quot;, &quot;restaurant_id&quot; : &quot;40365499&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c700&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;331&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.87786539999999, 40.8724377 ] }, &quot;street&quot; : &quot;East  204 Street&quot;, &quot;zipcode&quot; : &quot;10467&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;Irish&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-08-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2014-03-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 23 }, { &quot;date&quot; : ISODate(&quot;2013-09-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-12-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 27 }, { &quot;date&quot; : ISODate(&quot;2011-10-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 } ], &quot;name&quot; : &quot;Mcdwyers Pub&quot;, &quot;restaurant_id&quot; : &quot;40365893&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c71a&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;5820&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9002615, 40.885186 ] }, &quot;street&quot; : &quot;Broadway&quot;, &quot;zipcode&quot; : &quot;10463&quot; }, &quot;borough&quot; : &quot;Bronx&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-02-26T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2013-10-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 19 }, { &quot;date&quot; : ISODate(&quot;2013-05-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2012-11-20T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 18 }, { &quot;date&quot; : ISODate(&quot;2011-10-17T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2011-06-22T00:00:00Z&quot;), &quot;grade&quot; : &quot;C&quot;, &quot;score&quot; : 35 } ], &quot;name&quot; : &quot;The Punch Bowl&quot;, &quot;restaurant_id&quot; : &quot;40366497&quot; }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p>Cette fois ci, la requête affichera l’ensemble
de la collection avec les noms de quartier
affichés par ordre alphabétique. Les collections
du quartier de “Bronx” seront les premières à être affichées,
puis ensuite l’ordre par identifiant sera conservé
lorsque le nom de quartier sera le même pour plusieurs collections.</p>
<p><em><strong>Traduction SQL :</strong></em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"> </span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">borough</span><span class="p">,</span><span class="w"> </span><span class="n">_id</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="limit">
<h3><span class="section-number">5.2.4. </span>Limit<a class="headerlink" href="#limit" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Pourquoi l’utiliser ?</strong></em></p>
<p>L’étape <code class="docutils literal notranslate"><span class="pre">$limit</span></code> va simplement permettre de
limiter le nombre de documents voulant être
affichés par la requête. Il n’y a pas grand
intérêt à utiliser le limit tout seul. Généralement,
il est utilisé avec l’étape <code class="docutils literal notranslate"><span class="pre">$sort</span></code> vu précédemment.</p>
<p><em><strong>Comment ça fonctionne ?</strong></em></p>
<p><strong>Syntaxe</strong> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>db.coll.aggregate(
	[
	 {$limit : 5} 
	]
)
</pre></div>
</div>
<p>L’argument qui est pris par le <code class="docutils literal notranslate"><span class="pre">$limit</span></code> est toujours
un entier positif, qui va déterminer le nombre
de collections que l’on souhaite afficher.</p>
<p><em><strong>Exemple</strong></em></p>
<p>Dans cet exemple, on souhaite afficher les 3 quartiers
possédant le plus de restaurants.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$borough&quot;</span><span class="p">,</span> <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="mf">1</span><span class="p">}}},</span>
     <span class="p">{</span><span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">nb</span><span class="o">:</span> <span class="o">-</span><span class="mf">1</span><span class="p">}},</span>
     <span class="p">{</span><span class="nx">$limit</span><span class="o">:</span> <span class="mf">3</span><span class="p">}</span>
	<span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;Manhattan&quot;, &quot;nb&quot; : 10258 }
{ &quot;_id&quot; : &quot;Brooklyn&quot;, &quot;nb&quot; : 6085 }
{ &quot;_id&quot; : &quot;Queens&quot;, &quot;nb&quot; : 5656 }
</pre></div>
</div>
</div>
</div>
<p>On remarque ici que nous ne pouvons pas utiliser
l’étape <code class="docutils literal notranslate"><span class="pre">$limit</span></code> seul sans le sort.
Nous avons d’abord besoin de trier le nombre
de restaurants par ordre décroissant puis enfin<br />
préciser que nous souhaitons obtenir seulement les
3 premiers quartiers contenant le plus de restaurants.</p>
<p><em><strong>Traduction SQL :</strong></em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">borough</span><span class="p">)</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"> </span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">borough</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">borough</span><span class="p">)</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="match">
<h3><span class="section-number">5.2.5. </span>Match<a class="headerlink" href="#match" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Pourquoi l’utiliser</strong></em></p>
<p><code class="docutils literal notranslate"><span class="pre">$match</span></code> peut être utilisé comme un filtre, avec une condition. On pourrait le mettre n’importe où dans notre requête mais il est particulièrement intéressant en début ou en fin de requête.</p>
<p><em><strong>Comment ça fonctionne ?</strong></em></p>
<p><strong>Syntaxe</strong> :</p>
<p>Le <code class="docutils literal notranslate"><span class="pre">$match</span></code> est un requête du type de celles qu’on passe à <code class="docutils literal notranslate"><span class="pre">find</span></code>.</p>
<p><em><strong>Exemple :</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> 
  <span class="p">[</span>  
   <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;borough&quot;</span><span class="o">:</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">}},</span>
   <span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">},</span>
   <span class="p">{</span><span class="nx">$group</span> <span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$grades.grade&quot;</span><span class="p">,</span>
       <span class="nx">n</span><span class="o">:</span><span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
    <span class="p">{</span><span class="nx">$match</span><span class="o">:</span><span class="p">{</span><span class="nx">n</span><span class="o">:</span><span class="p">{</span><span class="nx">$gt</span><span class="o">:</span><span class="mf">1000</span><span class="p">}}},</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;B&quot;, &quot;n&quot; : 3055 }
{ &quot;_id&quot; : &quot;A&quot;, &quot;n&quot; : 17324 }
</pre></div>
</div>
</div>
</div>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">Borough</span><span class="o">=</span><span class="s1">&#39;Brooklyn&#39;</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">grade</span><span class="w"></span>
<span class="k">HAVING</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
</pre></div>
</div>
<p>Ici le premier <code class="docutils literal notranslate"><span class="pre">$match</span></code> sert comme un <code class="docutils literal notranslate"><span class="pre">WHERE</span></code>,
et le deuxième comme un <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> en SQL.</p>
<p>Dans tous les cas, le <code class="docutils literal notranslate"><span class="pre">$match</span></code> fait une sélection sur le jeu de données en fonction d’une condition, au moment où il est placé.</p>
<p>Si le <code class="docutils literal notranslate"><span class="pre">$match</span></code> est au début, il fera une sélection sur l’ensemble des données (ici <code class="docutils literal notranslate"><span class="pre">NYfood</span></code>) mais n’aura pas accès aux opérations qui sont effectuées après (comme le <code class="docutils literal notranslate"><span class="pre">$group</span></code> dans notre cas).
C’est pour cela qu’on utilise aussi le <code class="docutils literal notranslate"><span class="pre">$match</span></code> plus tard, pour avoir accès aux données créées avec nos bouts de requêtes précédents, ce qui permet ici d’avoir accès au <code class="docutils literal notranslate"><span class="pre">n</span></code>.
Cependant, ce dernier <code class="docutils literal notranslate"><span class="pre">$match</span></code> n’a pas accès à toute la base de données <code class="docutils literal notranslate"><span class="pre">NYfood</span></code> et n’agit que sur les résultats des requêtes précédentes.</p>
</div>
<div class="section" id="unwind">
<h3><span class="section-number">5.2.6. </span>Unwind<a class="headerlink" href="#unwind" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Pourquoi l’utiliser ?</strong></em></p>
<p>Il arrive que les documents de certaines collections possèdent pour attribut une liste. Lorsque l’on effectue une requête d’agrégation, il peut être nécéssaire d’agir non pas sur la liste mais sur chaque élément de la liste. Pour cela, on utilise la commande <code class="docutils literal notranslate"><span class="pre">$unwind</span></code>. Elle permet, pour chaque élément de la liste, de dupliquer le document pour chaque valeur de la liste.</p>
<p><em><strong>Comment ça fonctionne ?</strong></em></p>
<p><strong>Syntaxe</strong> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>db.coll.aggregate( 
  [
   {$unwind : &quot;$att&quot;}}
  ]
)
</pre></div>
</div>
<p>En général, un <code class="docutils literal notranslate"><span class="pre">$unwid</span></code> seul n’a peu d’intérêt.<code class="docutils literal notranslate"><span class="pre">$att</span></code> est une liste de taille 10 que la collection comporte 1000 individus, la requête d’exemple renverra un résultat de 10 000 lignes (10 * 1000)</p>
<p><em><strong>Exemple</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span> 
  <span class="p">[</span>
   <span class="p">{</span><span class="nx">$unwind</span> <span class="o">:</span><span class="s2">&quot;$grades&quot;</span><span class="p">},</span>
   <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span> <span class="o">:</span> <span class="s1">&#39;$grades.grade&#39;</span><span class="p">,</span> 
             <span class="nx">n</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span><span class="mf">1</span><span class="p">}}</span>
    <span class="p">},</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;P&quot;, &quot;n&quot; : 1197 }
{ &quot;_id&quot; : &quot;B&quot;, &quot;n&quot; : 12602 }
{ &quot;_id&quot; : &quot;Not Yet Graded&quot;, &quot;n&quot; : 524 }
{ &quot;_id&quot; : &quot;Z&quot;, &quot;n&quot; : 1337 }
{ &quot;_id&quot; : &quot;A&quot;, &quot;n&quot; : 74652 }
{ &quot;_id&quot; : &quot;C&quot;, &quot;n&quot; : 3145 }
</pre></div>
</div>
</div>
</div>
<p>Voici un exemple concret d’utilisation d’un <code class="docutils literal notranslate"><span class="pre">$unwind</span></code>. Dans la requête, on cherche à compter le nombre de A ayant été attribués à l’ensemble des restaurants de la collection, puis le nombre de B, C ….
Pour que cette requête fonctionne, le <code class="docutils literal notranslate"><span class="pre">$unwind</span></code> est obligatoire, sinon on considère la liste entière des notes et on ne peut donc pas compter.</p>
<p><em><strong>Traduction SQL :</strong></em></p>
<p>Il n’existe pas réellement d’équivalent SQL au <code class="docutils literal notranslate"><span class="pre">$unwind</span></code>. Néanmoins, il se rapproche d’une opération de jointure sans aucun filtre.</p>
</div>
<div class="section" id="quelques-requetes-pour-tout-comprendre">
<h3><span class="section-number">5.2.7. </span>Quelques requêtes pour tout comprendre<a class="headerlink" href="#quelques-requetes-pour-tout-comprendre" title="Permalink to this headline">¶</a></h3>
<p>Afin d’illustrer le fonctionnement pas à pas, découpons une requête en détail.
Pour cet exemple, on veut  <strong>les 3 notes les plus données dans les restaurants du quartier de Brooklyn</strong>.
La première étape naturelle est de sélectionner les restaurants présents uniquement dans le quartier de Brooklyn.
Pour cela on utilise <code class="docutils literal notranslate"><span class="pre">$match</span></code>, qui retourne uniquement les restaurants de Brooklyn.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>
     <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;borough&quot;</span><span class="o">:</span> <span class="s2">&quot;Brooklyn&quot;</span><span class="p">}},</span>
    	<span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;469&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.961704, 40.662942 ] }, &quot;street&quot; : &quot;Flatbush Avenue&quot;, &quot;zipcode&quot; : &quot;11225&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Hamburgers&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-12-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, { &quot;date&quot; : ISODate(&quot;2014-07-01T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 23 }, { &quot;date&quot; : ISODate(&quot;2013-04-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2012-05-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 } ], &quot;name&quot; : &quot;Wendy&#39;S&quot;, &quot;restaurant_id&quot; : &quot;30112340&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2780&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.98241999999999, 40.579505 ] }, &quot;street&quot; : &quot;Stillwell Avenue&quot;, &quot;zipcode&quot; : &quot;11224&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-06-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2013-06-05T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, { &quot;date&quot; : ISODate(&quot;2012-04-13T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2011-10-12T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 } ], &quot;name&quot; : &quot;Riviera Caterer&quot;, &quot;restaurant_id&quot; : &quot;40356018&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;7114&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9068506, 40.6199034 ] }, &quot;street&quot; : &quot;Avenue U&quot;, &quot;zipcode&quot; : &quot;11234&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Delicatessen&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-05-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2014-01-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2013-08-03T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, { &quot;date&quot; : ISODate(&quot;2012-07-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, { &quot;date&quot; : ISODate(&quot;2012-03-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2011-10-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 } ], &quot;name&quot; : &quot;Wilken&#39;S Fine Food&quot;, &quot;restaurant_id&quot; : &quot;40356483&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c689&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1839&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9482609, 40.6408271 ] }, &quot;street&quot; : &quot;Nostrand Avenue&quot;, &quot;zipcode&quot; : &quot;11226&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Ice Cream, Gelato, Yogurt, Ices&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-07-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2013-07-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, { &quot;date&quot; : ISODate(&quot;2012-07-11T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2012-02-23T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 } ], &quot;name&quot; : &quot;Taste The Tropics Ice Cream&quot;, &quot;restaurant_id&quot; : &quot;40356731&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68b&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;6409&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -74.00528899999999, 40.628886 ] }, &quot;street&quot; : &quot;11 Avenue&quot;, &quot;zipcode&quot; : &quot;11219&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-07-18T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2013-07-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2013-02-13T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2012-08-16T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 }, { &quot;date&quot; : ISODate(&quot;2011-08-17T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 } ], &quot;name&quot; : &quot;Regina Caterers&quot;, &quot;restaurant_id&quot; : &quot;40356649&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68c&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;7715&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9973325, 40.61174889999999 ] }, &quot;street&quot; : &quot;18 Avenue&quot;, &quot;zipcode&quot; : &quot;11214&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-04-16T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2013-04-23T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 }, { &quot;date&quot; : ISODate(&quot;2012-04-24T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, { &quot;date&quot; : ISODate(&quot;2011-12-16T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 } ], &quot;name&quot; : &quot;C &amp; C Catering Service&quot;, &quot;restaurant_id&quot; : &quot;40357437&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68d&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;1269&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.871194, 40.6730975 ] }, &quot;street&quot; : &quot;Sutter Avenue&quot;, &quot;zipcode&quot; : &quot;11208&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Chinese&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-09-16T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 21 }, { &quot;date&quot; : ISODate(&quot;2013-08-28T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, { &quot;date&quot; : ISODate(&quot;2013-04-02T00:00:00Z&quot;), &quot;grade&quot; : &quot;C&quot;, &quot;score&quot; : 56 }, { &quot;date&quot; : ISODate(&quot;2012-08-15T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 27 }, { &quot;date&quot; : ISODate(&quot;2012-03-28T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 27 } ], &quot;name&quot; : &quot;May May Kitchen&quot;, &quot;restaurant_id&quot; : &quot;40358429&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c68e&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;705&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9653967, 40.6064339 ] }, &quot;street&quot; : &quot;Kings Highway&quot;, &quot;zipcode&quot; : &quot;11223&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Jewish/Kosher&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-11-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 11 }, { &quot;date&quot; : ISODate(&quot;2013-10-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-10-04T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, { &quot;date&quot; : ISODate(&quot;2012-05-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 9 }, { &quot;date&quot; : ISODate(&quot;2011-12-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 19 } ], &quot;name&quot; : &quot;Seuda Foods&quot;, &quot;restaurant_id&quot; : &quot;40360045&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c690&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;203&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.97822040000001, 40.6435254 ] }, &quot;street&quot; : &quot;Church Avenue&quot;, &quot;zipcode&quot; : &quot;11218&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Ice Cream, Gelato, Yogurt, Ices&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-02-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 2 }, { &quot;date&quot; : ISODate(&quot;2013-01-02T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 }, { &quot;date&quot; : ISODate(&quot;2012-01-09T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 3 }, { &quot;date&quot; : ISODate(&quot;2011-11-07T00:00:00Z&quot;), &quot;grade&quot; : &quot;P&quot;, &quot;score&quot; : 12 }, { &quot;date&quot; : ISODate(&quot;2011-07-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 13 } ], &quot;name&quot; : &quot;Carvel Ice Cream&quot;, &quot;restaurant_id&quot; : &quot;40360076&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c692&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;6909&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -74.0259567, 40.6353674 ] }, &quot;street&quot; : &quot;3 Avenue&quot;, &quot;zipcode&quot; : &quot;11209&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Delicatessen&quot;, &quot;grades&quot; : [ { &quot;date&quot; : ISODate(&quot;2014-08-21T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 4 }, { &quot;date&quot; : ISODate(&quot;2014-03-05T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 3 }, { &quot;date&quot; : ISODate(&quot;2013-01-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 } ], &quot;name&quot; : &quot;Nordic Delicacies&quot;, &quot;restaurant_id&quot; : &quot;40361390&quot; }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p>Dans un second temps, il faut voir que pour récupérer les différentes valeurs de notes, il faut acceder à chaque élément de la liste et non la liste entière. Pour y accéder, il faut utiliser la commande <code class="docutils literal notranslate"><span class="pre">$unwind</span></code>, qui rendra donc à cette étape tous les restaurants de Brooklyn associés à une note qu’il a obtenu (Attention, cela retourne beaucoup de résultats : nombre de restaurants * nombre de notes)</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>
     <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;borough&quot;</span><span class="o">:</span> <span class="s2">&quot;Brooklyn&quot;</span><span class="p">}},</span>
     <span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">},</span>
    <span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;469&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.961704, 40.662942 ] }, &quot;street&quot; : &quot;Flatbush Avenue&quot;, &quot;zipcode&quot; : &quot;11225&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Hamburgers&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2014-12-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 8 }, &quot;name&quot; : &quot;Wendy&#39;S&quot;, &quot;restaurant_id&quot; : &quot;30112340&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;469&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.961704, 40.662942 ] }, &quot;street&quot; : &quot;Flatbush Avenue&quot;, &quot;zipcode&quot; : &quot;11225&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Hamburgers&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2014-07-01T00:00:00Z&quot;), &quot;grade&quot; : &quot;B&quot;, &quot;score&quot; : 23 }, &quot;name&quot; : &quot;Wendy&#39;S&quot;, &quot;restaurant_id&quot; : &quot;30112340&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;469&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.961704, 40.662942 ] }, &quot;street&quot; : &quot;Flatbush Avenue&quot;, &quot;zipcode&quot; : &quot;11225&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Hamburgers&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2013-04-30T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, &quot;name&quot; : &quot;Wendy&#39;S&quot;, &quot;restaurant_id&quot; : &quot;30112340&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c682&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;469&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.961704, 40.662942 ] }, &quot;street&quot; : &quot;Flatbush Avenue&quot;, &quot;zipcode&quot; : &quot;11225&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Hamburgers&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2012-05-08T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, &quot;name&quot; : &quot;Wendy&#39;S&quot;, &quot;restaurant_id&quot; : &quot;30112340&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2780&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.98241999999999, 40.579505 ] }, &quot;street&quot; : &quot;Stillwell Avenue&quot;, &quot;zipcode&quot; : &quot;11224&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2014-06-10T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 5 }, &quot;name&quot; : &quot;Riviera Caterer&quot;, &quot;restaurant_id&quot; : &quot;40356018&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2780&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.98241999999999, 40.579505 ] }, &quot;street&quot; : &quot;Stillwell Avenue&quot;, &quot;zipcode&quot; : &quot;11224&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2013-06-05T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 7 }, &quot;name&quot; : &quot;Riviera Caterer&quot;, &quot;restaurant_id&quot; : &quot;40356018&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2780&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.98241999999999, 40.579505 ] }, &quot;street&quot; : &quot;Stillwell Avenue&quot;, &quot;zipcode&quot; : &quot;11224&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2012-04-13T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, &quot;name&quot; : &quot;Riviera Caterer&quot;, &quot;restaurant_id&quot; : &quot;40356018&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c685&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;2780&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.98241999999999, 40.579505 ] }, &quot;street&quot; : &quot;Stillwell Avenue&quot;, &quot;zipcode&quot; : &quot;11224&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;American &quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2011-10-12T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 12 }, &quot;name&quot; : &quot;Riviera Caterer&quot;, &quot;restaurant_id&quot; : &quot;40356018&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;7114&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9068506, 40.6199034 ] }, &quot;street&quot; : &quot;Avenue U&quot;, &quot;zipcode&quot; : &quot;11234&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Delicatessen&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2014-05-29T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, &quot;name&quot; : &quot;Wilken&#39;S Fine Food&quot;, &quot;restaurant_id&quot; : &quot;40356483&quot; }
{ &quot;_id&quot; : ObjectId(&quot;61e6a0d95ecaf12919b5c688&quot;), &quot;address&quot; : { &quot;building&quot; : &quot;7114&quot;, &quot;loc&quot; : { &quot;type&quot; : &quot;Point&quot;, &quot;coordinates&quot; : [ -73.9068506, 40.6199034 ] }, &quot;street&quot; : &quot;Avenue U&quot;, &quot;zipcode&quot; : &quot;11234&quot; }, &quot;borough&quot; : &quot;Brooklyn&quot;, &quot;cuisine&quot; : &quot;Delicatessen&quot;, &quot;grades&quot; : { &quot;date&quot; : ISODate(&quot;2014-01-14T00:00:00Z&quot;), &quot;grade&quot; : &quot;A&quot;, &quot;score&quot; : 10 }, &quot;name&quot; : &quot;Wilken&#39;S Fine Food&quot;, &quot;restaurant_id&quot; : &quot;40356483&quot; }
Type &quot;it&quot; for more
</pre></div>
</div>
</div>
</div>
<p>Ensuite, pour savoir quelle note a été la plus attribuée, il faut grouper pour chaque valeur de note. On utilise donc un <code class="docutils literal notranslate"><span class="pre">$group</span></code> sur l’attribut <code class="docutils literal notranslate"><span class="pre">$grades.grade$</span> <span class="pre">(accessible</span> <span class="pre">grâce</span> <span class="pre">a</span> </code>$unwind<code class="docutils literal notranslate"><span class="pre">).</span> <span class="pre">Puis,</span> <span class="pre">on</span> <span class="pre">décide</span> <span class="pre">de</span> <span class="pre">compter</span> <span class="pre">le</span> <span class="pre">nombre</span> <span class="pre">d'itérations</span> <span class="pre">de</span> <span class="pre">chaque</span> <span class="pre">note</span> <span class="pre">stockée</span> <span class="pre">dans</span> <span class="pre">la</span> <span class="pre">variable</span> </code>nb`. Cette étape nous retourne donc le nombre de fois où chaque note a été attribuée à un restaurant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>
     <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;borough&quot;</span><span class="o">:</span> <span class="s2">&quot;Brooklyn&quot;</span><span class="p">}},</span>
     <span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">},</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$grades.grade&quot;</span><span class="p">,</span> <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="mf">1</span><span class="p">}}},</span>
    <span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;P&quot;, &quot;nb&quot; : 343 }
{ &quot;_id&quot; : &quot;B&quot;, &quot;nb&quot; : 3055 }
{ &quot;_id&quot; : &quot;Not Yet Graded&quot;, &quot;nb&quot; : 144 }
{ &quot;_id&quot; : &quot;Z&quot;, &quot;nb&quot; : 285 }
{ &quot;_id&quot; : &quot;A&quot;, &quot;nb&quot; : 17324 }
{ &quot;_id&quot; : &quot;C&quot;, &quot;nb&quot; : 811 }
</pre></div>
</div>
</div>
</div>
<p>Nous sommes donc tout proches du résultat espéré. Il reste maintenant à trier les résultats par ordre décroissant, afin d’avoir les notes les plus données au début : <code class="docutils literal notranslate"><span class="pre">{$sort:</span> <span class="pre">{nb:</span> <span class="pre">-1}}</span></code>. Mais comme l’énoncé le précise, on souhaite afficher uniquement les 3 notes les plus données. Etant donné que les notes sont triées, il faut seulement préciser : <code class="docutils literal notranslate"><span class="pre">{$limit:</span> <span class="pre">3}</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>
     <span class="p">{</span><span class="nx">$match</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;borough&quot;</span><span class="o">:</span> <span class="s2">&quot;Brooklyn&quot;</span><span class="p">}},</span>
     <span class="p">{</span><span class="nx">$unwind</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">},</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;$grades.grade&quot;</span><span class="p">,</span> <span class="nx">nb</span><span class="o">:</span> <span class="p">{</span><span class="nx">$sum</span><span class="o">:</span> <span class="mf">1</span><span class="p">}}},</span>
     <span class="p">{</span><span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">nb</span><span class="o">:</span> <span class="o">-</span><span class="mf">1</span><span class="p">}},</span>
     <span class="p">{</span><span class="nx">$limit</span><span class="o">:</span> <span class="mf">3</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : &quot;A&quot;, &quot;nb&quot; : 17324 }
{ &quot;_id&quot; : &quot;B&quot;, &quot;nb&quot; : 3055 }
{ &quot;_id&quot; : &quot;C&quot;, &quot;nb&quot; : 811 }
</pre></div>
</div>
</div>
</div>
<p>On obtient bien, avec cette requête, les 3 notes les plus attribuées aux restaurants de Brooklyn !</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span> <span class="nx">db</span><span class="p">.</span><span class="nx">NYfood</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">(</span>
	<span class="p">[</span>

     <span class="p">{</span><span class="nx">$project</span><span class="o">:</span> <span class="p">{</span><span class="nx">taille</span><span class="o">:</span> <span class="p">{</span><span class="nx">$size</span><span class="o">:</span> <span class="s2">&quot;$grades&quot;</span><span class="p">}}},</span>
     <span class="p">{</span><span class="nx">$match</span> <span class="o">:</span><span class="p">{</span><span class="nx">taille</span><span class="o">:</span><span class="p">{</span><span class="nx">$gt</span><span class="o">:</span><span class="mf">2</span><span class="p">}}},</span>
     <span class="p">{</span><span class="nx">$group</span><span class="o">:</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">nb_min</span><span class="o">:</span> <span class="p">{</span><span class="nx">$min</span><span class="o">:</span> <span class="s2">&quot;$taille&quot;</span><span class="p">},</span>
      <span class="nx">nb_max</span><span class="o">:</span> <span class="p">{</span><span class="nx">$max</span><span class="o">:</span> <span class="s2">&quot;$taille&quot;</span><span class="p">}}</span>
                        <span class="p">},</span>         
    <span class="p">]</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : null, &quot;nb_min&quot; : 3, &quot;nb_max&quot; : 9 }
</pre></div>
</div>
</div>
</div>
<p>Dans cette deuxième requête, on montre bien ici qu’il n’y a pas d’ordre pré-défini d’étape, et ici le <code class="docutils literal notranslate"><span class="pre">$match</span></code> n’est ni au début de la requête, ni à la fin.</p>
<p>Expliquons cette requête (qui n’a pas beaucoup d’intérêt pratique).</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$project</span></code> : création de la variable taille, qui correspond au nombre de notes données à un restaurant.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$match</span></code> : Dans le tableau rendu précédemment, on ne prend que les restaurants ayant plus de 2 notes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$group</span></code> : Sur le résultat de la requête précédente, on groupe tout les restaurants (_id : null), et on regarde le nombre minimum et maximum de notes attribuées
à un restaurant. (Ayant sélectionné les individus supérieurs à deux, le minimum ne pouvait être que 3 ou plus.</p></li>
</ul>
<p>En SQL, on aurait :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">taille</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">taille</span><span class="p">),</span><span class="k">MIN</span><span class="p">(</span><span class="n">taille</span><span class="p">)</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">NYfood</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">taille</span><span class="o">&gt;=</span><span class="mi">2</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Résultat final : Le nombre minimum et maximum de notes attribué aux restaurants ayant au moins deux notes.</strong></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "imongo"
        },
        kernelOptions: {
            kernelName: "imongo",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'imongo'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="04_index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">4. </span>Les index</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="06_modif.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Les requêtes de modification</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Ouvrage collectif<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>